---
- hosts: all
  become: true
  become_user: root

  vars:
  #connection
    ansible_become: true
    ansible_become_user: root
  #chroot
    data_folder: /var/www/data
  #users
    public_key: ssh-rsa some/pub/key
  #swap
    swapfile_path: /extra_swap
    swapfile_size: 2048
  #PHP
    php_version: 7.4 #'{{ php }}'
  #AWS Enhanced Networking
    # ixgbevf_version: 4.3.5

  tasks:

   - include_tasks: repos.yml
   - include_tasks: packages.yml
   - include_tasks: swap.yml
     # when: '"amazon" in ansible_product_version'
   - include_tasks: users.yml
   - include_tasks: firewalld.yml
     # when: '"amazon" in ansible_product_version'
   - include_tasks: fail2ban.yml
   - include_tasks: php.yml
   - include_tasks: composer.yml
   # - include_tasks: moosh.yml
   # - include_tasks: aws-ena.yml
     # when: '"amazon" in ansible_product_version'
   - include_tasks: nginx.yml
   # - include_tasks: solr.yml
   # - include_tasks: unoconv-server.yml

   - name: data folder
     file:
       path: "{{ data_folder }}"
       state: directory

   - name: sshd config
     template:
       src: sshd_config
       dest: /etc/ssh/sshd_config
     register: sshd_config

   - name: restart sshd
     service:
       name: sshd
       state: restarted
     when: sshd_config.changed
